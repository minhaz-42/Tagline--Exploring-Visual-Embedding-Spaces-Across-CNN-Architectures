{% extends "base.html" %}
{% load static %}

{% block title %}Evaluation Metrics — Model Comparison{% endblock %}
{% block nav_metrics %}active{% endblock %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">Evaluation Metrics</h1>
    <p class="page-subtitle">
        Quantitative comparison of embedding quality across
        ResNet-101, ZFNet, and GoogLeNet on {{ total_classes }} classes
        ({{ total_images }} images, leave-one-out evaluation).
    </p>
</header>

<!-- ═══════════════════════════════════════════ -->
<!-- DYNAMIC: Last Query Metrics                -->
<!-- ═══════════════════════════════════════════ -->
{% if last_query %}
<section class="metrics-section" style="border:2px solid var(--accent);border-radius:12px;padding:1.5rem;margin-bottom:2rem;background:rgba(99,102,241,0.04);">
    <h2 class="section-title" style="display:flex;align-items:center;gap:0.5rem;">
        &#x1F50D; Latest Query Results
        <span class="meta-badge model-badge" style="font-size:0.8rem;">{{ last_query.model_name }}</span>
    </h2>
    <p class="section-subtitle">Dynamic metrics from your most recent image query (this section updates every search)</p>

    <div class="info-grid">
        <!-- Query Image + Predicted Class -->
        <div class="info-card" style="text-align:center;">
            <h3>Query Image</h3>
            {% if last_query.query_image_url %}
            <img src="{% static last_query.query_image_url %}" alt="Last query" style="max-height:120px;border-radius:8px;margin:0.5rem auto;">
            {% endif %}
            <div class="info-dim" style="font-size:1.2rem;color:var(--accent);margin-top:0.5rem;">
                Predicted: {{ last_query.predicted_class }}
            </div>
        </div>

        <!-- Similarity Metrics -->
        <div class="info-card">
            <h3>Query Similarity Scores</h3>
            <div class="table-wrapper" style="margin-top:0.5rem;">
                <table class="metrics-table" style="max-width:100%;">
                    <thead>
                        <tr><th>Metric</th><th>Value</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>Top-1 Similarity</td><td><strong>{{ last_query.top1_similarity }}</strong></td></tr>
                        <tr><td>Avg Top-10 Similarity</td><td><strong>{{ last_query.avg_similarity }}</strong></td></tr>
                        <tr><td>Min Top-10 Similarity</td><td>{{ last_query.min_similarity }}</td></tr>
                        <tr><td>Class Consistency</td><td>{{ last_query.class_consistency }}%</td></tr>
                        <tr>
                            <td>Confidence</td>
                            <td>
                                {% if last_query.confidence_level == "high" %}
                                <span style="color:#16a34a;font-weight:700;">&#x2713; High</span>
                                {% elif last_query.confidence_level == "medium" %}
                                <span style="color:#ca8a04;font-weight:700;">&#x26A0; Medium</span>
                                {% else %}
                                <span style="color:#dc2626;font-weight:700;">&#x26A0; Low</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Database Comparison -->
        <div class="info-card">
            <h3>Database Comparison</h3>
            <div class="table-wrapper" style="margin-top:0.5rem;">
                <table class="metrics-table" style="max-width:100%;">
                    <thead>
                        <tr><th>Metric</th><th>Value</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>DB Mean Similarity</td><td>{{ last_query.db_mean_similarity }}</td></tr>
                        <tr><td>DB Max Similarity</td><td>{{ last_query.db_max_similarity }}</td></tr>
                        <tr><td>DB Std Deviation</td><td>{{ last_query.db_std_similarity }}</td></tr>
                        <tr><td>Model Used</td><td>{{ last_query.model_name }} ({{ last_query.embedding_dim }}-d)</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Class Distribution -->
    {% if last_query.class_distribution %}
    <div style="margin-top:1rem;">
        <h3 style="margin-bottom:0.75rem;">Top-10 Class Distribution</h3>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            {% for cd in last_query.class_distribution %}
            <span class="meta-badge" style="font-size:0.85rem;">
                {{ cd.class_name }}: {{ cd.count }} ({{ cd.pct }}%)
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</section>
{% else %}
<section class="metrics-section" style="border:1px dashed var(--border);border-radius:12px;padding:1.5rem;margin-bottom:2rem;text-align:center;">
    <p style="color:var(--text-muted);margin:0;">
        &#x1F50D; <strong>No query performed yet.</strong>
        <a href="{% url 'search_page' %}">Upload an image</a> to see per-query metrics here.
    </p>
</section>
{% endif %}

<!-- ═══════════════════════════════════════════ -->
<!-- STATIC: Dataset-level Metrics              -->
<!-- ═══════════════════════════════════════════ -->
<section class="metrics-section">
    <h2 class="section-title">Dataset Retrieval Performance (Static Benchmark)</h2>
    <p class="section-subtitle">Top-10 retrieval accuracy and Mean Average Precision computed via leave-one-out cosine similarity on the full dataset. These values stay fixed until you rerun the offline pipeline.</p>

    <div class="table-wrapper">
        <table class="metrics-table">
            <thead>
                <tr>
                    <th>Model</th>
                    <th>Embedding Dim</th>
                    <th>Top-10 Accuracy</th>
                    <th>Top-10 Accuracy %</th>
                    <th>Mean Average Precision (mAP)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    <td class="model-cell">
                        <strong>{{ row.model_name }}</strong>
                    </td>
                    <td>
                        <span class="dim-badge">{{ row.embedding_dim }}-d</span>
                    </td>
                    <td>
                        {% if row.top_k_accuracy != "N/A" %}
                            <div class="metric-bar">
                                <span class="metric-value">{{ row.top_k_accuracy_fmt }}</span>
                                <div class="metric-bar-track">
                                    <div class="metric-bar-fill" style="width:{{ row.top_k_pct }}%"></div>
                                </div>
                            </div>
                        {% else %}
                            <span class="metric-na">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.top_k_accuracy != "N/A" %}
                            <span class="metric-value">{{ row.top_k_pct }}%</span>
                        {% else %}
                            <span class="metric-na">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row.mAP != "N/A" %}
                            <div class="metric-bar">
                                <span class="metric-value">{{ row.mAP_fmt }}</span>
                                <div class="metric-bar-track">
                                    <div class="metric-bar-fill" style="width:{{ row.mAP_pct }}%"></div>
                                </div>
                            </div>
                        {% else %}
                            <span class="metric-na">N/A</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if not rows %}
    <div class="alert alert-info">
        <span><strong>Note:</strong> Run the offline extraction pipeline first to generate evaluation metrics:
        <code>python run_pipeline.py --dataset_dir ./dataset</code></span>
    </div>
    {% endif %}
</section>

<!-- Methodology Note -->
<section class="metrics-section">
    <h2 class="section-title">Methodology</h2>
    <div class="info-grid">
        <div class="info-card">
            <h3>Top-K Accuracy</h3>
            <div class="info-dim">Precision@10</div>
            <p>For each image in the dataset, we treat it as a query (leave-one-out) and retrieve the 10 
            nearest neighbours by cosine similarity. Top-K accuracy measures the fraction of retrieved 
            items sharing the query's class label, averaged over all {{ total_images }} queries.</p>
        </div>
        <div class="info-card">
            <h3>Mean Average Precision</h3>
            <div class="info-dim">mAP</div>
            <p>For each query, we compute Average Precision across the full ranked retrieval list, 
            then average over all queries. mAP captures both precision and recall across all 
            rank positions, providing a comprehensive retrieval quality measure.</p>
        </div>
        <div class="info-card">
            <h3>Dataset</h3>
            <div class="info-dim">{{ total_classes }} Classes</div>
            <p>Evaluated on {{ total_images }} images from {{ total_classes }} dataset classes.
            All models use ImageNet pre-trained weights.</p>
        </div>
    </div>
</section>

<!-- t-SNE Visualizations -->
<section class="tsne-section">
    <h2 class="section-title">t-SNE Embedding Visualizations (Static Dataset Maps)</h2>
    <p class="section-description">
        2-D t-SNE projections of the full dataset embedding spaces.
        These plots are generated offline and do not change per query; they update only when you rerun the pipeline.
    </p>

    {% if tsne_plots %}
    <div class="tsne-grid">
        {% for key, plot in tsne_plots.items %}
        <div class="tsne-card">
            <h3 class="tsne-model-name">
                {% if key == "resnet" %}ResNet-101 (2048-d)
                {% elif key == "zfnet" %}ZFNet (4096-d)
                {% elif key == "googlenet" %}GoogLeNet / Inception v1 (1024-d)
                {% endif %}
            </h3>
            <div class="info-dim" style="margin-bottom:0.5rem;">Last updated: {{ plot.updated_at }}</div>
            <img src="{% static plot.url %}" alt="t-SNE for {{ key }}" class="tsne-image">
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <span><strong>Note:</strong> t-SNE plots have not been generated yet.
        Run: <code>python run_pipeline.py --dataset_dir ./dataset</code></span>
    </div>
    {% endif %}
</section>

<!-- Back -->
<div class="actions">
    <a href="{% url 'search_page' %}" class="btn btn-secondary">&larr; Back to Search</a>
</div>
{% endblock %}
