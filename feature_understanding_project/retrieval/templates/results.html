{% extends "base.html" %}
{% load static %}
{% load retrieval_tags %}

{% block title %}Results â€” {{ model_name }}{% endblock %}
{% block nav_search %}active{% endblock %}

{% block content %}
<!-- Query Info Banner -->
<section class="results-header">
    <h1 class="page-title">
        {% if is_historical %}Saved Result{% else %}Retrieval Results{% endif %}
    </h1>
    <div class="result-meta">
        <span class="meta-badge model-badge">{{ model_name }}</span>
        <span class="meta-badge">Top-10 by Cosine Similarity</span>
        {% if query_metrics.confidence_level == "high" %}
        <span class="meta-badge confidence-high">&#x2713; High Confidence</span>
        {% elif query_metrics.confidence_level == "medium" %}
        <span class="meta-badge confidence-medium">&#x26A0; Medium Confidence</span>
        {% elif query_metrics.confidence_level == "low" %}
        <span class="meta-badge confidence-low">&#x26A0; Low Confidence</span>
        {% endif %}
        {% if is_historical %}
        <span class="meta-badge history-date-badge">
            &#x1F4C5; {{ search_date|date:"d M Y, H:i" }}
        </span>
        {% endif %}
    </div>
</section>

<!-- Summary Banner -->
{% if query_metrics %}
<section class="summary-section">
    <div class="summary-card">
        <!-- Query Image (inline) -->
        <div class="summary-media">
            <img src="{% static query_image_url %}" alt="Query image"
                 class="summary-query-image">
        </div>
        <!-- Quick Stats -->
        <div>
            <div class="summary-title-row">
                <span class="summary-predicted-class">{{ query_metrics.predicted_class }}</span>
                <span class="summary-predicted-label">&mdash; predicted class</span>
            </div>
            <div class="summary-stats">
                <div>
                    <span class="summary-stat-label">Top-1 Sim</span><br>
                    <strong class="summary-stat-value">{{ query_metrics.top1_similarity }}</strong>
                </div>
                <div>
                    <span class="summary-stat-label">Avg Sim</span><br>
                    <strong class="summary-stat-value">{{ query_metrics.avg_similarity }}</strong>
                </div>
                <div>
                    <span class="summary-stat-label">Consistency</span><br>
                    <strong class="summary-stat-value">{{ query_metrics.class_consistency }}%</strong>
                </div>
                <div>
                    <span class="summary-stat-label">Results</span><br>
                    <strong class="summary-stat-value">{{ query_metrics.total_results }}</strong>
                </div>
            </div>
        </div>
    </div>
</section>
{% else %}
<!-- Fallback: Query Image only -->
<section class="query-section">
    <h2 class="section-title">Query Image</h2>
    <div class="query-card">
        <img src="{% static query_image_url %}" alt="Query image" class="query-image">
    </div>
</section>
{% endif %}

<!-- Retrieved Images Grid -->
<section class="results-section">
    <h2 class="section-title">Top-10 Retrieved Images</h2>
    <div class="results-grid">
        {% for r in results %}
        <div class="result-card">
            <div class="result-rank">#{{ r.rank }}</div>
            <div class="result-image-wrapper">
                <img src="{% dataset_image r.image_path %}"
                     alt="{{ r.class_name }}"
                     class="result-image"
                     loading="lazy">
            </div>
            <div class="result-info">
                <span class="result-class">{{ r.class_name }}</span>
                <span class="result-similarity" title="Cosine similarity">
                    {{ r.similarity }}
                </span>
            </div>
        </div>
        {% empty %}
        <p class="no-results">No results found. Make sure embeddings have been generated.</p>
        {% endfor %}
    </div>
</section>

<!-- Detailed Metrics (collapsible) -->
{% if query_metrics %}
        <section class="metrics-section metrics-section-compact">
    <details open>
                <summary class="details-summary">
            &#x1F4CA; Detailed Query Metrics
        </summary>

        <div class="info-grid">
            <!-- Similarity Scores -->
            <div class="info-card">
                <h3>Similarity Scores</h3>
                <div class="table-wrapper table-wrapper-tight">
                    <table class="metrics-table metrics-table-full">
                        <tbody>
                            <tr><td>Top-1 Similarity</td><td><strong>{{ query_metrics.top1_similarity }}</strong></td></tr>
                            <tr><td>Average (Top-10)</td><td><strong>{{ query_metrics.avg_similarity }}</strong></td></tr>
                            <tr><td>Minimum (Top-10)</td><td>{{ query_metrics.min_similarity }}</td></tr>
                            {% if query_metrics.db_mean_similarity %}
                            <tr><td>DB Mean Similarity</td><td>{{ query_metrics.db_mean_similarity }}</td></tr>
                            <tr><td>DB Max Similarity</td><td>{{ query_metrics.db_max_similarity }}</td></tr>
                            <tr><td>DB Std Deviation</td><td>{{ query_metrics.db_std_similarity }}</td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Classification -->
            <div class="info-card">
                <h3>Classification</h3>
                <div class="table-wrapper table-wrapper-tight">
                    <table class="metrics-table metrics-table-full">
                        <tbody>
                            <tr><td>Predicted Class</td><td><strong class="text-accent">{{ query_metrics.predicted_class }}</strong></td></tr>
                            <tr><td>Class Consistency</td><td>{{ query_metrics.class_consistency }}%</td></tr>
                            <tr>
                                <td>Confidence</td>
                                <td>
                                    {% if query_metrics.confidence_level == "high" %}
                                    <span class="confidence-text-high">&#x2713; High</span>
                                    {% elif query_metrics.confidence_level == "medium" %}
                                    <span class="confidence-text-medium">&#x26A0; Medium</span>
                                    {% else %}
                                    <span class="confidence-text-low">&#x26A0; Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Class Distribution -->
            {% if query_metrics.class_distribution %}
            <div class="info-card">
                <h3>Class Distribution</h3>
                <div class="table-wrapper table-wrapper-tight">
                    <table class="metrics-table metrics-table-full">
                        <thead><tr><th>Class</th><th>Count</th><th>%</th></tr></thead>
                        <tbody>
                            {% for cd in query_metrics.class_distribution %}
                            <tr>
                                <td><strong>{{ cd.class_name }}</strong></td>
                                <td>{{ cd.count }}</td>
                                <td>
                                    <div class="metric-bar">
                                        <span class="metric-value">{{ cd.pct }}%</span>
                                        <div class="metric-bar-track">
                                            <div class="metric-bar-fill" style="width:{{ cd.pct }}%"></div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </details>
</section>
{% endif %}

<!-- Actions -->
<div class="actions actions-top">
    <a href="{% url 'search_page' %}" class="btn btn-secondary">&larr; New Search</a>
    <a href="{% url 'metrics' %}" class="btn btn-outline">&#x1F4CA; Metrics</a>
    <a href="{% url 'history' %}" class="btn btn-outline">&#x1F4CB; History</a>
    {% if search_id %}
    <span class="permalink-note">
        Permalink: <a href="{% url 'result_detail' search_id %}" class="permalink-link">Result #{{ search_id }}</a>
    </span>
    {% endif %}
</div>
{% endblock %}
